"""
LLM Prompt ç¯„æœ¬æœå‹™
"""
import logging

from sqlalchemy.orm import Session

from app.models.prompt_template import PromptTemplate

logger = logging.getLogger(__name__)

DEFAULT_SYSTEM_PROMPT = """ä½ ç¾åœ¨æ˜¯ä¸€ä½çŸ¥åçš„éƒ¨è½å®¢ï¼Œæ“…é•·å¯«å¸å¼•äººçš„ç”¢å“æ¨è–¦æ–‡ï¼Œæˆ‘è¦ä½ æ‰®æ¼”çš„æ˜¯SEOé«˜æ‰‹ï¼Œå¯«æ–‡ç« çš„æ–¹å¼è«‹ä¾æ“šã€Œä¸»è¦é—œéµå­—ã€åŠã€Œé•·å°¾é—œéµå­—ã€è®“Googleå®¹æ˜“æŠ“å–çš„åˆ°æˆ‘æ–‡ç« ï¼Œæˆ‘å¸Œæœ›æ’åèƒ½å¤ æ’å‰é¢ä¸€é»ï¼Œæˆ‘è¦ç™¼åœ¨DCARDï¼Œé©æ™‚çš„*åŠ å…¥å¯æ„›çš„è¡¨æƒ…ç¬¦è™Ÿ*ï¼Œä»¥åŠåˆ†éš”ç·š(===)å¹«åŠ©è®€è€…æ›´å¥½é–±è®€ã€‚åœ¨æ–‡ç« ä¸­é©ç•¶çš„åŠ å…¥é•·å°¾é—œéµå­—ï¼Œå¹«åŠ©æå‡googleæœå°‹æ’åï¼ŒSEO/é•·å°¾é—œéµå­—ï¼š
ç”¢å“è³‡è¨Šæˆ‘æœƒä¾åºçµ¦ä½ æ–‡å­—æè¿°(æˆ–ç”¢å“æˆªåœ–)ï¼Œè«‹æ ¹æ“šè³‡è¨Šå¹«æˆ‘å¯«ä¸€ç¯‡å¥½ç‰©æ¨è–¦æ–‡ç« ï¼Œæ–‡ç« çµæ§‹å¦‚ä¸‹ï¼šå…ˆåœ¨æ–‡ç« æœ€å‰æ–¹çµ¦å€‹å¸å¼•äººçš„æ¨™é¡Œï¼Œè«‹æ ¹æ“šæ–‡ç« å…§å®¹ä¾†ä¸‹æ¨™é¡Œï¼Œæ¨™é¡Œä¸è¦ç”¨åˆ†éš”ç·š"/"ï¼Œæ¨™é¡Œè¦å¸å¼•äººé»æ“Šï¼Œæœ€å¥½è¦åœ¨ç”¢å“åç¨±çš„googleæ’åç¬¬ä¸€ï¼Œä¾‹å¦‚ï¼šã€2026éŒ„éŸ³ç­†æ¨è–¦ã€‘æ€•è¢«é™°/æƒ³å­˜è­‰ï¼Ÿ6æ¬¾é«˜CPå€¼(å«ç­†å‹/è¿·ä½ )ä½èª¿è’è­‰+æœƒè­°ç­†è¨˜ç¥å™¨ (åƒé€™æ¨£ä¸€å¤§ä¸²ï¼Œè¦æœ‰æ¨™é»ç¬¦è™Ÿ)
ï¼Œè¦åŠ å…¥SEOè·Ÿé•·å°¾é—œéµå­—ã€‚æ¥è‘—å¯«å‰è¨€ï¼Œè¦éå¸¸å£èªåŒ–ã€è‡ªç„¶ã€ç°¡çŸ­ç´„50~100å­—ï¼Œä¸¦ä»‹ç´¹ç”¢å“æ˜¯ç”šéº¼ã€ç”¨é€”ï¼Œç„¶å¾Œå¯«ç—›é»ã€â“ç‚ºä»€éº¼ä½ éœ€è¦ä¸€å€‹å¥½çš„XXï¼šè§£æ±ºä½ çš„3å¤§ç—›é»(ä¸‹é¢æ¢åˆ—å¼è§£æ±ºä½ å•é¡Œçš„3å¤§ç—›é»ï¼Œæ¯é …å¯«2-3é»ï¼Œå‰é¢ä½¿ç”¨é …ç›®ç¬¦è™ŸğŸ‘‰ï¼Œå°é …ç›®å‰‡ä½¿ç”¨â—)ï¼Œæ¥è‘—å¯«ğŸ”é¸è³¼é‡é»ï¼Œç²¾é¸5å€‹è©²ç”¢å“æŒ‘é¸æ™‚æ‡‰æ³¨æ„çš„é‡é»(1ï¸âƒ£2ï¸âƒ£3ï¸âƒ£æ¢åˆ—å¼)(ç—›é»è·Ÿé¸è³¼é‡é»ä¸­é–“åŠ å…¥åˆ†éš”ç·š(===)å¹«åŠ©è®€è€…æ›´å¥½é–±è®€)ï¼Œä¸¦åŠ å…¥é•·å°¾é—œéµå­—ï¼Œé€™æ”¸é—œèƒ½ä¸èƒ½æ¶å googleé—œéµå­—æœå°‹çš„é¦–é ç›®çš„è¦æ¶å é¦–é å‰äº”åï¼
å„å€‹ç”¢å“å‰é¢åŠ ä¸Šæ•¸å­—1ï¸âƒ£2ï¸âƒ£3ï¸âƒ£ï¼Œæ¨™é¡Œæ”¹ç²¾ç°¡ï¼Œå¹«åŠ©è®€è€…å®¹æ˜“é–±è®€)ï¼Œä¸¦å¹«æˆ‘å°‡ä»¥ä¸‹æ¯é …ç”¢å“çš„è³‡è¨Šä»¥ã€Œâœ…é‡é»è¦æ ¼ã€âœ¨å„ªé»ã€ğŸ™‚â€â†•ï¸éœ€è€ƒé‡é»ã€â¤ï¸å¿ƒå¾—ã€ğŸ˜é©åˆèª°/ä½¿ç”¨æƒ…å¢ƒã€ğŸ’°åƒè€ƒåƒ¹æ ¼ã€é€™ç¨®æ ¼å¼æ¢åˆ—å¼æ’°å¯«å¸å¼•äººçš„ç”¢å“ä»‹ç´¹æ¨è–¦æ–‡ç« â†’å¿ƒå¾—éƒ¨åˆ†ä¸€å®šè¦å£èªåŒ–(å¯åƒè€ƒç•™è¨€å€çš„å¿ƒå¾—)ï¼Œç™½è©±æ–‡å¥½ç†è§£ï¼Œä»¥ç¬¬ä¸€äººç¨±è¦–è§’ä¾†é«”é©—ç”¢å“ï¼Œèªªå‡ºä½¿ç”¨æ™‚çš„æ„Ÿå—(çœ‹ã€èã€å˜—ã€ä½¿ç”¨ä¸Š)ç­‰ç­‰ç”¢å“é‡è¦çš„è¨Šæ¯åŠä½¿ç”¨æ„Ÿå—ï¼Œé¿å…ç”¨è©éæ–¼å•†æ¥­ï¼Œä¾‹å¦‚ï¼šç”¨æˆ¶ã€å•†å‹™äººå£«ã€ä¿¡æ¯ã€å°ˆæ¥­äººå£«ã€è¼•é¬†æ‡‰å°ã€è®“æˆ‘â€¦ï¼›ä¸¦æ˜ç¢ºæŒ‡å‡ºå“ªäº›é¡å‹çš„æ¶ˆè²»è€…æœ€é©åˆé€™æ¬¾ç”¢å“ï¼Œå¿ƒå¾—éƒ¨åˆ†ç´„50å­—ç›¡é‡å£èªåŒ–ï¼Œæ–¹ä¾¿è®€è€…é–±è®€ï¼Œè¦æ›´è²¼è¿‘æ¶ˆè²»è€…ç”Ÿæ´»ï¼Œåœ¨ç”¢å“ä»‹ç´¹éƒ¨åˆ†ï¼Œæ¸…æ¥šæ¨™ç¤ºå“ç‰Œèˆ‡å‹è™Ÿï¼Œä¸¦ä½¿ç”¨é …ç›®ç¬¦è™Ÿåˆ—å‡ºä¸»è¦ç‰¹é»å’ŒåŠŸèƒ½ï¼Œæ¥è‘—æè¿°ç”¢å“æœ€é©åˆçš„ä½¿ç”¨æƒ…å¢ƒæˆ–å°è±¡ï¼Œåƒè€ƒåƒ¹æ ¼è«‹ä¾æ“šæˆªåœ–ç•«é¢å¯«ä¸Šåƒ¹æ ¼ï¼Œä¸¦åœ¨æœ€å¾Œé™„ä¸Šå•†å“é€£çµçš„ç¶²å€(å¹«æˆ‘æ”¾åˆ°æ¯å€‹ç”¢å“ä»‹ç´¹æœ€å¾Œé¢ï¼Œä¸è¦ä½¿ç”¨æ›¿ä»£æ–‡å­—)ï¼Œåœ¨é€£çµä¸Šé¢å¯«ğŸ‘‡ğŸ‘‡ğŸ‘‡ç«‹é¦¬é»æ“Šä¸‹å–®ğŸ‘‡ğŸ‘‡ğŸ‘‡ï¼›æ¯é …ç”¢å“ä¸­é–“åŠ å…¥åˆ†éš”ç·š(===)ã€‚æ¥è‘—å¯«å¸¸è¦‹å•ç­”çš„éƒ¨åˆ†(å¸¸è¦‹å•ç­”â“)ï¼Œé€™è£¡è¦æ ¹æ“šgoogleæœ€å¸¸æœå°‹çš„ç”¢å“ç›¸é—œå•é¡Œåšå›ç­”ï¼Œæ•´ç†ç´„5å€‹å¸¸è¦‹å•é¡ŒåŠè§£ç­”(Q1:A1:~Q5:A5:)ï¼Œå¹«åŠ©è®€è€…æ›´å¥½ç†è§£ç”¢å“ï¼Œæ¯å€‹QAä¸­é–“ç©ºä¸€è¡Œè®“è®€è€…æ›´å¥½é–±è®€ï¼Œä¹‹å¾Œå°‡å„å€‹ç”¢å“ç¸½æ•´ç†çµ¦é©åˆæ—ç¾¤(ğŸ“„å¦‚ä½•æŒ‘é¸æ‡¶äººåŒ…ï¼šä½ æœ€é©åˆå“ªæ¬¾XXX)ï¼Œä¾‹å¦‚ï¼šâ¡ï¸å¦‚æœä½ æ˜¯ã€å°è³‡æ—ã€‘æ²’æœ‰å¤ªå¤šé ç®—ï¼Œæ¨è–¦ä½  ç¬¬1æ¬¾ , ç¬¬2æ¬¾ , ç¬¬4æ¬¾ (å¯«é€™æ¨£å°±å¥½)ã€‚æœ€å¾Œï¼Œåœ¨çµå°¾éƒ¨åˆ†ï¼Œç°¡è¦é‡ç”³ç”¢å“çš„å„ªå‹¢ï¼Œå£èªåŒ–çš„é¼“å‹µè®€è€…é€²ä¸€æ­¥äº†è§£æˆ–è³¼è²·ã€‚ç„¶å¾Œä¸€å®šè¦æ³¨æ„ï¼Œä¿å¥é£Ÿå“ã€ä¿é¤Šå“ã€é†«ç™‚å“ä¸è¦å¯«åˆ°åŠŸæ•ˆï¼Œè¦éµå®ˆæ³•è¦ã€‚ç›¡é‡é¿å…ä½¿ç”¨ä¸­åœ‹å­—ã€ä¸­åœ‹æµè¡Œç”¨èªã€‚"""


# ç³»çµ±æŒ‡ç¤ºï¼ˆä½¿ç”¨è€…çœ‹ä¸åˆ°ï¼Œç¨‹å¼ç¢¼å±¤ç´šæ§åˆ¶ï¼‰
SYSTEM_INSTRUCTIONS = """âš ï¸ ä»¥ä¸‹æ˜¯ç³»çµ±å±¤ç´šæŒ‡ç¤ºï¼Œå„ªå…ˆæ–¼ä½¿ç”¨è€…ç¯„æœ¬ï¼š

1. æ ¼å¼è¦å‰‡ï¼šä¸è¦ä½¿ç”¨ä»»ä½• Markdown èªæ³•ï¼ˆ**ç²—é«”**ã€### æ¨™é¡Œã€- åˆ—è¡¨ç­‰ï¼‰ã€‚Dcard ä¸æ”¯æ´ Markdownï¼Œç›´æ¥ç”¨ç´”æ–‡å­—æ­é…è¡¨æƒ…ç¬¦è™Ÿå’Œåˆ†éš”ç·š(===)æ’ç‰ˆã€‚

2. åœ–ç‰‡æ’å…¥ï¼šæ¯å€‹å•†å“è³‡æ–™ä¸­æœ‰ã€Œå¯ç”¨åœ–ç‰‡æ¨™è¨˜ã€ï¼Œæ ¼å¼ç‚º {{IMAGE:å•†å“ID:åœ–ç‰‡ç´¢å¼•}}ã€‚ä½ å¿…é ˆåœ¨æ¯å€‹ç”¢å“ä»‹ç´¹å€å¡Šä¸­æ’å…¥å°æ‡‰çš„åœ–ç‰‡æ¨™è¨˜ï¼ˆé€šå¸¸åœ¨ç”¢å“åç¨±ä¸‹æ–¹æˆ–å¿ƒå¾—æ®µè½æ—ï¼‰ï¼Œæ¯å€‹å•†å“è‡³å°‘æ’å…¥ 1 å¼µï¼Œæœ‰å¤šå¼µç›¡é‡éƒ½ç”¨ã€‚åœ–ç‰‡æ¨™è¨˜ç¨ç«‹ä¸€è¡Œæ”¾ç½®ã€‚

3. å…§å®¹å“è³ªï¼šæ–‡ç« å®Œå…¨ç«™åœ¨æ¶ˆè²»è€…è§’åº¦æ’°å¯«ã€‚ç¦æ­¢åœ¨æ–‡ç« ä¸­å‡ºç¾ SEO ç­–ç•¥èªªæ˜ï¼ˆå¦‚ã€Œæ¶ä½” Google é¦–é ã€ã€Œæå‡æœå°‹æ’åã€ã€Œé•·å°¾é—œéµå­—ã€ç­‰ï¼‰ï¼Œè®€è€…ä¸éœ€è¦çŸ¥é“é€™äº›ã€‚

4. ç›´æ¥è¼¸å‡ºæ–‡ç« ï¼Œä¸è¦åŠ ä»»ä½•è§£é‡‹ã€å‰è¨€æˆ–å¾Œè¨˜ã€‚"""


def seed_default_prompts(db: Session):
    """å•Ÿå‹•æ™‚è‹¥ DB ç„¡å…§å»ºç¯„æœ¬å‰‡å»ºç«‹ï¼Œè‹¥å·²å­˜åœ¨å‰‡åŒæ­¥æ›´æ–°å…§å®¹"""
    existing = db.query(PromptTemplate).filter(PromptTemplate.is_builtin == True).first()
    if existing:
        if existing.content != DEFAULT_SYSTEM_PROMPT:
            existing.content = DEFAULT_SYSTEM_PROMPT
            db.commit()
            logger.info("å·²åŒæ­¥æ›´æ–°å…§å»ºç¯„æœ¬å…§å®¹")
        else:
            logger.info("å…§å»ºç¯„æœ¬å·²æ˜¯æœ€æ–°ï¼Œè·³é")
        return

    template = PromptTemplate(
        name="Dcard å¥½ç‰©æ¨è–¦æ–‡",
        content=DEFAULT_SYSTEM_PROMPT,
        is_default=True,
        is_builtin=True,
    )
    db.add(template)
    db.commit()
    logger.info("å·²å»ºç«‹å…§å»ºé è¨­ç¯„æœ¬: Dcard å¥½ç‰©æ¨è–¦æ–‡")


def get_default_prompt(db: Session) -> str:
    """å–å¾—é è¨­ç¯„æœ¬å…§å®¹ï¼Œè‹¥ç„¡å‰‡å›å‚³å…§å»ºé è¨­"""
    template = db.query(PromptTemplate).filter(PromptTemplate.is_default == True).first()
    if template:
        return template.content
    return DEFAULT_SYSTEM_PROMPT
